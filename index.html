<!DOCTYPE html>
<html lang="en">
  <head>
    <script> 
      var 版本="v0.93";
      
      // login
      var loginUnit="";
      var loginPwd="";
      // Configuratiion
      var experimental=false;
      var local_api = false;
      
      if (local_api) {
        var apiUrlBase = "http://localhost:5000/";
      } else {
        var apiUrlBase = "https://golden-found-api.herokuapp.com/";
      }

      console.log(版本);   
      console.log(apiUrlBase);   
      
    </script>
         
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <meta name="description" content="金機">
    <meta name="keywords" content="admin, estimates, bootstrap, business, corporate, creative, management, minimal, modern, accounts, invoice, html5, responsive, CRM, Projects">
    <meta name="author" content="">
    <meta name="robots" content="noindex, nofollow">
    <title>金機</title>

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">

    <!-- Fontawesome CSS -->
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">

    <!--font style-->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">

    <!-- Lineawesome CSS -->
    <link rel="stylesheet" href="assets/css/line-awesome.min.css">

    <!-- Select2 CSS -->
    <link rel="stylesheet" href="assets/css/select2.min.css">

    <!-- Datetimepicker CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap-datetimepicker.min.css">

    <!-- Datatable CSS -->
    <link rel="stylesheet" href="assets/css/dataTables.bootstrap4.min.css">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="assets/css/theme-settings.css">

    <!-- Loading CSS -->
    <link rel="stylesheet" href="assets/css/loading.css" />
    
    <!-- View BigImg-->
    <link rel="stylesheet" href="./view-bigimg.css">
    <script src="./view-bigimgMy.js"></script>    

    <!-- Main CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- My CSS -->
    <link rel="stylesheet" href="assets/css/myCss.css">
  </head>
   
    <body id="skin-color" class="inter">
      
      <!-- Main Wrapper -->
      <div class="main-wrapper">

        <!-- Header -->
        <div class="header" id="heading">
        <!--Move to heading.html, loaded by JS-->
        </div>
        <!-- /Header -->

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar" style="display:none">
          <!-- Move to sidebar.html, loaded by JS-->           
        </div>
        <!-- /Sidebar -->

       <!-- Page Wrapper -->
        <div class="page-wrapper" id="login-page" style="margin-left:450px;">

          <!-- Page Content -->               
          <div class="content container-fluid">

             <!-- Content Starts -->
            <div id="">                              
              <div class="login_form">
                <form class="loginbox" autocomplete="off">
                  <input placeholder="名字" type="text" id="username" value="admin">
                  <input placeholder="密碼" type="password" id="password">
                  <button onClick="login()" id="login_button">Login</button>
                </form>
              </div>            
            </div>        
            <!-- /Content End -->
          </div>
          <!-- /Page Content -->
        </div>
        <!-- /Page Wrapper -->		
                     

        <!-- Page Wrapper -->
        <div class="page-wrapper" id="body-report-page" style="margin-left:450px; display:none">

          <!-- Page Content -->               
          <div class="content container-fluid">

            <div style="margin-top: -20px">
              
<!--              <button style="margin-left:180px" class="btn-gradient-primary font-weight-bold" onclick="prevReport()" >-->
              <button style="position:absolute; top:70px; left:200px" class="btn-gradient-primary font-weight-bold" onclick="prevReport()" >
                <span id="ml-身體組成前一筆">前一筆</span>
              </button>             
              <label id="LTinfo" style="position:absolute; top:70px; left:270px;"></label> 

              <button style="position:absolute; top:70px; left:1158px" class="btn-gradient-primary font-weight-bold" onclick="nextReport()" >
                <span id="ml-身體組成下一筆">下一筆</span>
              </button>
              
              <label id="RTinfo" style="position:absolute; top:70px; left:720px;"></label>               
            </div>

            <!-- Page Header -->

            <!-- Content Starts -->
<!--            <div style="margin-left: -450px; margin-top:8px; width:600px ">-->
            <div style="position:absolute; top:120px;left:-430px; width:600px ">
            <div id="身體組成紀錄表" class="row">
              <div class="col-md-12">
                <div class="card mb-0">
                  <div class="card-body">
                    <div class="table-responsive">
                      <table id="身體組成紀錄" class="table table-striped table-nowrap custom-table mb-0" style="width:100%">
                        <thead>
                          <tr>
                            <th id="ml-量測日期">量測日期</th>
                            <th id="ml-姓名">姓名</th>
                            <th id="ml-電話">電話</th>
                            <th id="ml-健康分數">健康分數</th>                
                            <th id="ml-完成登錄"></th>
                         </tr>
                        </thead>
                      </table>
                    </div>
                  </div>
                </div>		
              </div>
            </div>
            </div>
                        
            <div id="wrap">                              
              <img id="LL" style="width:500px;position:absolute; top:120px;left:-300px; display:none" src="./noPrev.jpg"/ alt="image">
              <img id="LT" style="width:500px;position:absolute; top:120px;left:200px; z-index:0" src="./blank.jpg"/ alt="此報告缺失圖片">
              <img id="RT" style="width:500px;position:absolute; top:120px;left:720px; z-index:0" src="./noNext.jpg"/ alt="此報告缺失圖片">
              <img id="RR" style="width:500px;position:absolute; top:120px;left:1220px; display:none" src="./noNext.jpg"/ alt="image">              
            </div>        
            <!-- /Content End -->
          </div>
          <!-- /Page Content -->
        </div>
        <!-- /Page Wrapper -->		

                                          
        <!-- Page Wrapper -->
        <div class="page-wrapper" id="membership-page" style="margin-left:450px;display:none">

          <!-- Page Content -->               
          <div class="content container-fluid" style="margin-left:0px">         
            <div class="crms-title row bg-white" >
              <div class="col ">
                <h3 class="page-title m-0">
                  <span class="page-title-icon bg-gradient-primary text-white ">
                    <i class="fa fa-user-o" aria-hidden="true"></i>
                  </span>
                  <span id="ml-資料標題"> 會員資料 </span>
                  <span style="float:right;margin-top:5px">
                    <button onClick="show_body_report_page()" style="border:none;background-color: transparent">
                      <i class="fa fa-plus" style="color:royalblue"> 新增會員</i>                      
                    </button>
                  </span>
                </h3>
              </div>
            </div>

            <div id="chartDiv" style="display:none; margin-left:20px">
              <div>
                <button onClick="show會員資料表()" style="border:none; font-size:25px;margin-top:0px; margin-left:0px; background-color:transparent"><i class="fa fa-times" ></i>
                <span style="font-size:16px"> 關閉</span></button>
<!--
                           
                <div class="rec" style="margin-left:-200px;margin-top:0px; width:200px;height:608px; border-style:solid;border-color:black; border-width:1px; overflow:hidden; overflow-y:scroll;padding-top:5px">
                  <button style="text-align:left; border:none; background-color:#F7F7F7">
                    2021/11/23 <br> 
                    4.5kg, 45cm, BMI:10   
                  </button>
                </div>           
-->
              </div>
              
              <div>
                <button class="selectedBtn">日</button>
                <button class="unselectedBtn">週</button>
                <button class="unselectedBtn">月</button>
              </div>
                        
              <div style="margin-top:0px">
<!--
                <button onclick="alert('Demo 版不支援')" style="color:#FF4350; background-color:transparent; float:left; font-size:20px;margin-left:40px; margin-top:-5px; border:none"><i class="fa fa-arrow-left"></i></button>
                <button onclick="alert('Demo 版不支援')" style="color:#FF4350; background-color:transparent; float:right; font-size:20px;margin-right:20px; margin-top:-5px; border:none"><i class="fa fa-arrow-right"></i></button>   
-->
                
                <input id="dateSlider" type="range" style="margin-top:30px;width:100%; margin-left:10px" min="0" max="8">
                                                       
                <div style="text-align: center">
                  <div id="nowDate" >2021/11/23</div> <br>
                  <div id="nowWeight" style="margin-top:-20px;font-size:30px; color:#ff6984">4.5kg</div>
                </div>

                <canvas id="myChartWeight" width="1000px" height="170px" style="margin:10px; margin-top:0px"></canvas>  

                <div style="text-align:center">
                  <div id="nowWeight" style="margin-top:10px;font-size:30px; color:#698040">53.2cm</div>
                </div>
                                    
                <canvas id="myChartHeight" width="1000px" height="170px" style="margin:10px; margin-top:0px"></canvas>   
                
                <div style="text-align:center">
                  <div id="nowWeight" style="margin-top:10px;font-size:30px; color:#6980b0">BMI: 20.6</div>
                </div>
                                
                <canvas id="myChartBMI"    width="1000px" height="170px" style="margin:10px; margin-top:0px"></canvas>   
              </div>                        
                                                       
                                       
            </div>

            <!-- Content Starts -->            
            <div id="會員資料表" class="row">
              <div class="col-md-12">
                <div class="card mb-0">
                  <div class="card-body">
                    <div class="table-responsive">
                      <table id="身高體重BMI會員" class="table table-striped table-nowrap custom-table mb-0" style="width:100%">
                        <thead>
                          <tr>
                            <th id="ml-ID">ID</th>
                            <th id="ml-姓名">姓名</th>
                            <th id="ml-性別">性別</th>
                            <th id="ml-父母">父母</th>
                            <th id="ml-父母電話">父母電話</th>
                            <th id="ml-備註說明">備註說明</th>                
                            <th id="ml-量測記錄"></th>
                            <th id="ml-完成登錄"></th>
                         </tr>
                        </thead>
                      </table>
                    </div>
                  </div>
                </div>		
              </div>
            </div>
            <!-- /Content End -->
          </div>
          <!-- /Page Content -->
        </div>
        <!-- /Page Wrapper -->

        <!-- Page Wrapper -->
        <div class="page-wrapper" id="expire-page" style="display:none">

          <!-- Page Content -->               
          <div class="content container-fluid">

            <div class="crms-title row bg-white">
              <div class="col ">
                <h3 class="page-title m-0">
                  <span class="page-title-icon bg-gradient-primary text-white ">
                    <i class="fa fa-bell-o" aria-hidden="true"></i>
                  </span>
                  <span id="ml-檢查即將到期合約"> 檢查即將到期合約 </span>
                </h3>
              </div>
            </div>

            <div style="margin: 10px">
              <span style="margin-left:0px" id ="ml-開始日期">  開始日期 </span> 
              <input id="expQueryStartDate" type='date' />
              
              <span style="margin-left:30px" id ="ml-結束日期"> 結束日期 </span> 
              <input id="expQueryEndDate"   type='date' />
              
              <button style="margin-left:30px" class="btn-gradient-primary font-weight-bold" onclick="checkExpirations()" >
                <span id="ml-檢查">檢 查</span>
              </button>
            </div>

            <!-- Page Header -->

            <!-- Content Starts -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card mb-0">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="expirations" class="table table-striped table-nowrap custom-table mb-0">
                                    <thead>
                                        <tr>
                                            <th id="ml-店鋪名稱">店鋪名稱</th>												
                                            <th id="ml-客戶名字">客戶名字</th>
                                            <th id="ml-合約編號">合約編號</th>
                                            <th id="ml-課程種類">課程種類</th>
                                            <th id="ml-合約狀態">合約狀態</th>
                                            <th id="ml-合約到期日期">合約到期日期</th>
                                            <th id="ml-延展到期日期">延展到期日期</th>
                                            <th id="ml-第一次上課時間">第一次上課時間</th>
                                            <th id="ml-負責教練">負責教練</th>										
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>		
                </div>
            </div>
            <!-- /Content End -->

          </div>
          <!-- /Page Content -->

        </div>
        <!-- /Page Wrapper -->		
				

      </div>
      <!-- /Main Wrapper -->

      <!-- jQuery -->
      <script src="assets/js/jquery-3.5.0.min.js"></script>

      <!-- Bootstrap Core JS -->
      <script src="assets/js/popper.min.js"></script>
      <script src="assets/js/bootstrap.min.js"></script>

      <!-- Slimscroll JS -->
      <script src="assets/js/jquery.slimscroll.min.js"></script>

      <script src="assets/js/select2.min.js"></script>

      <!-- Datatable JS -->
      <script src="assets/js/jquery.dataTables.min.js"></script>
      <script src="assets/js/dataTables.bootstrap4.min.js"></script>

      <!-- Datetimepicker JS -->
      <script src="assets/js/moment.min.js"></script>
      <script src="assets/js/bootstrap-datetimepicker.min.js"></script>

      <!-- theme JS -->
      <script src="assets/js/theme-settings.js"></script>

      <!-- Custom JS -->
      <script src="assets/js/app.js"></script>

      <!-- loading JS -->
      <script src="assets/js/loading.js"></script>

      <!-- Multi-langs JS -->
      <script src="multiLangsTable.js"></script>	
      <script src="assets/js/multi-langs.js"></script>	

      <!--dataTables 1.7.0 -->
      <script src="assets/js/dataTables.buttons.min.js"></script>

      <!-- jszip 3.1.3-->
      <script src="assets/js/jszip.min.js"></script>
      
      <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  -->
      <script src="assets/js/chart3.6.0.js"></script>  

      <!-- pdfmake 支援中文字型比較麻煩，不先用
      <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
      -->

      <!-- HTML5 export buttons for Buttons and DataTables. 2016 SpryMedia Ltd - datatables.net/license
      FileSaver.js (1.3.3) - MIT license Copyright © 2016 Eli Grey - http://eligrey.com -->
      <script src="assets/js/buttons.html5.min.js  "></script>

      <script src="functions.js"></script>
      
      <!-- Load heading and sidebar script-->
      <script type="text/javascript">
        loadPages();
      </script>
         
      <!-- Main Start-->
      <script type="text/javascript"> 
        
        var 客戶名稱;
        var 使用身體組成=false;
        var 使用身高體重BMI=false;
        var 使用握力器=false;

        var LLindex=-1;
        var LTindex=-1;
        var RTindex=-1;
        var RRindex=-1;
        
        
        var today = new Date();
        
        var contractSessionHistory={};
        var courseSettings={};
        var returnFromAPI=[]; // for test
        
        // variables for each page
        var index_is_loaded = false;
        var expire_is_loaded = false;
        var query_sessions_is_load = false;

        var bodyCompositionResult=[];
        var memberResult=[];
        var expResult=[];
        var querySessionsResult=[];
        
        var viewer = new ViewBigimg();

        //var wrap = document.getElementById('wrap');
        var wrap = $("#wrap");
        wrap[0].onclick = function (e) {
          console.log(e.target.nodeName)
          if (e.target.nodeName === 'IMG') {
            $("#heading").hide();
            $("#sidebar").hide();          
            viewer.show(e.target.src);
          }
        }        
        
        $("#password").focus();

//        $("#rsvQueryStartDate").val(today.toISOString().substr(0,10)); 
//        $("#rsvQueryEndDate").val(today.toISOString().substr(0,10));           $("#expQueryStartDate").val(today.toISOString().substr(0,10)); 
//        $("#expQueryEndDate").val(today.toISOString().substr(0,10)); 
//        $("#sessionQueryStartDate").val(today.toISOString().substr(0,10)); 
//        $("#sessionQueryEndDate").val(today.toISOString().substr(0,10));         

        var bodyCompositionTable =$('#身體組成紀錄').DataTable( {
          dom: 'Bfrtip',
          buttons: [
            { "extend": 'csv', "text":'<span id="ml-匯出CSV">匯出 CSV</span>',"className": 'btn-gradient-primary font-weight-bold' },
            { "extend": 'excel', "text":'<span id="ml-匯出EXCEL">匯出 EXCEL</span>',"className": 'btn-gradient-primary font-weight-bold' }

          ],            
          order: [[ 0, "desc" ], [ 4, "desc" ] ],
          select: true,
          data: bodyCompositionResult,    
          pageLength: 8,
          columnDefs: [
            { targets: -1, 
              render: function (data, type, row, meta) {  
                //console.log("***********", type);
                return  `<button id="checkDetails`+data.toString()+`" class="確定登錄按鈕" onClick="showReport(`+data+`)">`+'查看報告'+`</button>`;
              },
            },                             
          ]           
        } );
        
        var memberTable =$('#身高體重BMI會員').DataTable( {
          dom: 'Bfrtip',
          buttons: [
        //                'copyHtml5',
        //                'excelHtml5',
        //                'csvHtml5',
        //                'pdfHtml5'
            { "extend": 'csv', "text":'<span id="ml-匯出CSV">匯出 CSV</span>',"className": 'btn-gradient-primary font-weight-bold' },
            { "extend": 'excel', "text":'<span id="ml-匯出EXCEL">匯出 EXCEL</span>',"className": 'btn-gradient-primary font-weight-bold' }

          ],            
          order: [[ 0, "asc" ]],
          data: memberResult,    
          pageLength: 7,
          columnDefs: [
            { targets: -1, 
              render: function (data, type, row, meta) {  
                return  `<button id="checkDetails`+meta.row.toString()+`" class="確定登錄按鈕" onClick="show_measurements(`+meta.row+`)">`+'查看紀錄'+`</button>`;
              },
            },            
            { targets: -2, 
              render: function (data, type, row, meta) { 
                //console.log("bbb", meta);
                return  `<button class="確定登錄按鈕" onClick="alert('Demo 版不支援')">`+'修改資料'+`</button>`;
                //return  `<button class="確定登錄按鈕" onClick="show_measurements(`+meta.row+`)">`+'修改資料'+`</button>`;     
                
                // checkbox 留著參考
                //if (data==true) return  '<i class="fa fa-check-square-o" aria-hidden="true"></i><span //style="display:none" >Y</span>';
                //else            return  '<i class="fa fa-times" aria-hidden="true"></i><span //style="display:none">N</span>';

              },
            },                 
          ]           
        } );
        
        function showReport(index){
          LTindex = index;
          
          console.log(index);
        
          var prevReports = findPrev2Reports(index);
          var nextReports = findNext2Reports(index);
          
          console.log(prevReports, nextReports);
                    
          if(prevReports.prev1.index>-1){
            $("#LL").attr("src", prevReports.prev1.imgPath);
            LLindex=prevReports.prev1.index;
          } else {
            $("#LL").attr("src", "./noPrev.jpg");            
          }
          
          $("#LT").attr("src", bodyCompositionResult[LTindex][5]);
          
          var LTInfoStr = bodyCompositionResult[LTindex][0]+" "+
                           bodyCompositionResult[LTindex][1]+ //.substr(0,10)+
                           " <b>健康分數:</b><span style='font-size:28px'>"+
                           bodyCompositionResult[LTindex][3]+"</span>";
          $("#LTinfo").html(LTInfoStr);  
          
          if(nextReports.next1.index>-1){
            $("#RT").attr("src", nextReports.next1.imgPath);
            RTindex = nextReports.next1.index;
            var RTInfoStr = bodyCompositionResult[nextReports.next1.index][0]+" "+
                             bodyCompositionResult[nextReports.next1.index][1]+ //.substr(0,10)+
                             " <b>健康分數:</b><span style='font-size:28px'>"+
                             bodyCompositionResult[nextReports.next1.index][3]+"</span>";
            $("#RTinfo").html(RTInfoStr);            
          } else {
            $("#RT").attr("src", "./noNext.jpg");
            $("#RTinfo").html("");  
          }
          
          if(nextReports.next2.index>-1){
            $("#RR").attr("src", nextReports.next2.imgPath);
            RRindex = nextReports.next1.index;            
          } else {
            $("#RR").attr("src", "./noNext.jpg");
          }
                
          
        }

        function findPrev2Reports(index){
          console.log(index);
          var retuenObj={
            "prev1": {index:-1, imgPath:""},
            "prev2": {index:-1, imgPath:""}          
          };
          var tmp;
          var phoneNumber=bodyCompositionResult[index][2];
          //console.log(phoneNumber);
          for (var i=index-1; i>-1; i--) {
            //console.log(bodyCompositionResult[i][2]);
            if (bodyCompositionResult[i][2]==phoneNumber){
              retuenObj.prev1.index=i;
              retuenObj.prev1.imgPath=bodyCompositionResult[i][5];
              tmp=i-1;
              break;
            }
          }
          if(tmp>-1) {
            //console.log(tmp);
            for (var i=tmp; i>-1; i--) {
              if (bodyCompositionResult[i][2]==phoneNumber){
                retuenObj.prev2.index=i;
                retuenObj.prev2.imgPath=bodyCompositionResult[i][5];
                break;
              }
            } 
          }
          return(retuenObj);
        }
        
        function findNext2Reports(index){
          console.log(index);
          var retuenObj={
            "next1": {index:-1, imgPath:""},
            "next2": {index:-1, imgPath:""}          
          };
          var tmp;
          var phoneNumber=bodyCompositionResult[index][2];
          //console.log(phoneNumber);
          for (var i=index+1; i<bodyCompositionResult.length; i++) {
            //console.log(bodyCompositionResult[i][2]);
            if (bodyCompositionResult[i][2]==phoneNumber){
              retuenObj.next1.index=i;
              retuenObj.next1.imgPath=bodyCompositionResult[i][5];
              tmp=i+1;
              break;
            }
          }
          if(tmp<bodyCompositionResult.length) {
            //console.log(tmp);
            for (var i=tmp; i<bodyCompositionResult.length; i++) {
              if (bodyCompositionResult[i][2]==phoneNumber){
                retuenObj.next2.index=i;
                retuenObj.next2.imgPath=bodyCompositionResult[i][5];
                break;
              }
            } 
          }
          return(retuenObj);
        }        
        
        //show_membership_page();
        //show_body_report_page();
        
        async function login() {
          event.preventDefault();
          console.log("login:", $("#username").val(),$("#password").val());
          
          if ($("#username").val()=='' || $("#password").val()=='') {
            alert("名字和密碼不得空白");
            return;
          }
          
          // call API for checking username/password
          $.loading.start('讀取資料');
          var noMatch=false;
          var databaseErr = false;
          var returnObj={};
          apiUrl = apiUrlBase+"?API=03&SuperKey=mpn6hnClHg&UserId="+$("#username").val()+"&Password="+$("#password").val();
          console.log(apiUrl);
          await $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "text", //必需視傳回值，設定 text 或 json
            success: function(returnData) {
              $.loading.end();
              console.log(returnData);
              if (returnData.includes("ERROR")) {
                noMatch=true;
              } else {
                returnObj=JSON.parse(returnData);
                客戶名稱=returnObj.客戶名稱;
                for (var i=0; i<returnObj.使用設備.length; i++){
                  if (returnObj.使用設備[i].includes("身體組成")) 使用身體組成=true;
                  if (returnObj.使用設備[i].includes("身高體重")) 使用身高體重BMI=true;
                  if (returnObj.使用設備[i].includes("握力器"))   使用握力器=true;
                }
              }
            },

            error: function(e) {
              $.loading.end();
              alert("登入失敗，請檢查網路!")
              $("#password").val("");
              console.log("error", e);
              databaseErr=true;
            }
          });            
          
          if (databaseErr) {
            alert("資料庫讀取錯誤!");
            return;
          }
          
          if (noMatch) {
            alert("名字與密碼不符!");
            return;
          }          
              
          console.log("使用身體組成,使用身高體重BMI,使用握力器:", 使用身體組成, 使用身高體重BMI, 使用握力器);
          
          var 使用設備Str= "";
          使用設備Str = (使用身體組成)?   (使用設備Str+"    身體組成分析儀\n"):使用設備Str;
          使用設備Str = (使用身高體重BMI)?(使用設備Str+"    身高體重BMI計\n"):使用設備Str;
          使用設備Str = (使用握力器)?     (使用設備Str+"    握力器\n"):使用設備Str;
          
          if (使用身體組成)    $("#ml-身體組成資料").show();
          if (使用身高體重BMI) $("#ml-身高體重BMI").show();
          if (使用握力器)      $("#ml-握力資料").show();
          
          alert("歡迎登入 "+客戶名稱+" 查詢系統! \n使用設備有,\n"+使用設備Str+"\n使用後請記得登出");
          
          // 先使用 身體組成
          if (使用身體組成) {
            $(".page-wrapper").hide(); // hide all pages with page-wrapper class
            $("#ml-head_title").text("身體組成報告");
            $("#ml-登入單位").text(客戶名稱);
            $("#ml-登入單位").show();
            $("#ml-登出").show();
            read身體組成資料();
            show_body_report_page();
            //show_membership_page();
          } else if (使用身高體重BMI) {
          } else if (使用握力器) {
          }
        }
        
        function logout(){
          客戶名稱="";
          show_login_page();
          $("#password").focus();
          //$("#username").val("");
          $("#password").val("");          
          $("#ml-登入單位").hide();
          $("#ml-登出").hide();          
          $("#ml-head_title").text("請登入系統");
          客戶名稱="";
          使用身體組成=false;    $("#ml-握力資料").hide();
          使用身高體重BMI=false; $("#ml-身高體重BMI").hide();
          使用握力器=false;     $("#ml-握力資料").hide();           
        }
        
        function dateTimeConv(timestamp){
          var tmp = new Date(timestamp+8*60*60*1000);
          var tmpStr= tmp.toISOString();
          tmpStr=tmpStr.replace('T',' ');
          tmpStr=tmpStr.replace('Z','');
          return(tmpStr);
          
        }
        
        async function read身體組成資料(){

          bodyCompositionResult=[];
          
          apiUrl = apiUrlBase+"?API=11&Unit="+客戶名稱+"&MeasureType=身體組成";
          console.log(apiUrl);          
          var databaseErr=false;
          var readErr=false;
          var returnObj={};
          $.loading.start('讀取資料');
          await $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "text",
            success: function(returnData) {            
              $.loading.end();
              if (returnData.includes("ERROR")) {
                readErr=true;
              } else {
                returnObj=JSON.parse(returnData);
                console.log(returnObj.length, returnObj[0].量測簡要)
              }
                
              var prevTime="";
              var prevUser="";
              for (var i=0; i<returnObj.length; i++) {
                //var createDate=new Date(returnObj[i].量測簡要.量測時間);
                
                if(returnObj[i].量測簡要.使用者名字==undefined) returnObj[i].量測簡要.使用者名字="無名氏";
                
                var measureTime=dateTimeConv(returnObj[i].量測簡要.量測時間).substr(0,19);
                var thisUser=returnObj[i].量測簡要.使用者名字;
                
                //處理重複的報告
                if ((measureTime==prevTime) && (thisUser==prevUser)){             
                  var repeatDateTime= new Date(measureTime);
                  var repeatTimestamp = repeatDateTime.getTime() +1000;
                  measureTime = dateTimeConv(repeatTimestamp).substr(0,19);
                }
                bodyCompositionResult[i] = [
                  //dateTimeConv(returnObj[i].量測簡要.量測時間).substr(0,19),
                  measureTime,
                  returnObj[i].量測簡要.使用者名字,
                  returnObj[i].量測簡要.使用者電話,
                  returnObj[i].量測簡要.HealthScore,
                  //returnObj[i].量測簡要.量測要求編號,
                  i,
                  returnObj[i].量測簡要.PicUrl
                ];
                
                prevTime = measureTime;
                prevUser = returnObj[i].量測簡要.使用者名字;
              }
              
              //console.log(bodyCompositionResult);
              bodyCompositionTable.clear();
              bodyCompositionTable.rows.add(bodyCompositionResult).draw();  
              
              //showReport(bodyCompositionResult.length-1);
               
            },

            error: function(e) {
              $.loading.end();
              console.log("error", e);
              databaseErr=true;
            }
          });                 
        }
          
        
        function show_login_page(){
          $(".page-wrapper").hide(); // hide all pages with page-wrapper class
          $("#login-page").show();            
        } 
        
        function show_body_report_page(){
          $(".page-wrapper").hide(); 
          $("#body-report-page").show(); 
          $("#ml-身體組成資料").hide();
        } 
        
        function show_measurements(data){
          //console.log(memberResult[data]);
          if (data==0) {
            $("#會員資料表").hide();
            $("#chartDiv").show();
            $('#ml-資料標題').text('量測記錄');
            drawChart();
          } else {
            alert("Demo 版不支援")
          }
        }

        function prevReport(){
          var LLimgPath = $("#LL").attr("src");
          var LTimgPath = $("#LT").attr("src");
          var RTimgPath = $("#RT").attr("src");
          var RRimgPath = $("#RR").attr("src");
          
          if(LLimgPath=="./noPrev.jpg") {
            alert("前面已無資料");
            return;
          }
        
          $("#LL").show();
          
          $("#LL").animate({left:200},1000);
          $("#RT").animate({left:1220},1000);
          $("#LT").animate({left:720},1000, function() {
            $("#LT").css('left','200px');
            $("#RT").css('left','720px');
            $("#LL").hide();            
            $("#LL").css('left','-300px')  
            showReport(LLindex);            
          });
        }
        
        function nextReport(){ 
          var LLimgPath = $("#LL").attr("src");
          var LTimgPath = $("#LT").attr("src");
          var RTimgPath = $("#RT").attr("src");
          var RRimgPath = $("#RR").attr("src");
          
          if(RRimgPath=="./noNext.jpg") {
            alert("後面已無資料");
            return;
          }
 
          $("#RR").show();
          
          $("#RR").animate({left:720},1000);
          $("#LT").animate({left:-300},1000);
          $("#RT").animate({left:200},1000, function() {
            $("#RT").css('left','720px');
            $("#LT").css('left','200px');
            $("#RR").hide();            
            $("#RR").css('left','1220px') 
            showReport(RTindex);
          });
        }
        
        
        var ctxW;
        var ctxH;
        var ctxB;
        var myChartWeight;
        var myChartHeight;
        var myChartBMI;
        function drawChart(){
            ctxW = $('#myChartWeight');
            myChartWeight = new Chart(ctxW, {
              type: 'line',
              data: {
                labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
                datasets: [{
                  backgroundColor: [
                    'rgba(255, 99, 132, 0.9)'
                  ],
                  label: '體重(公斤)',
                  data: [3.95, 4.13, 4.21, 4.26, 4.28, 4.35, 4.52],
                  tension: 0.3
                }]
              },
              options: {
                plugins: { 
                  legend: {
                    display: false,
                    position: 'left'
                  }
                },                
                scales: {
                  x: {
                    ticks: {
                      display: false //this will remove only the label
                    }
                  }
                }
              }              
            });      

            ctxH = $('#myChartHeight');
            myChartHeight = new Chart(ctxH, {
              type: 'line',
              data: {
                labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
                datasets: [{
                  backgroundColor: [
                    'rgba(99, 128, 64, 0.9)'
                  ],
                  label: '身高(公分)',
                  data: [50.1, 52.3, 54.7, 55.9, 56.8, 58.1, 60.2]
                }]
              },
              options: {
                plugins: { 
                  legend: {
                    display: false,
                    position: 'left'
                  }
                },                
                scales: {
                  x: {
                    ticks: {
                      display: false //this will remove only the label
                    }
                  }
                }
              }
            });    

            ctxB = $('#myChartBMI');
            myChartBMI = new Chart(ctxB, {
              type: 'line',
              data: {
                labels: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
                datasets: [{
                  backgroundColor: [
                    'rgba(99, 128, 196, 0.9)'
                  ],
                  label: 'BMI          ',
                  data: [20.6, 19.8, 20.1, 19.51, 17.81, 16.22, 15.9]
                }]
              },
              options: {
                plugins: { 
                  legend: {
                    display: false,
                    position: 'left'
                  }
                },                
                scales: {
                  x: {
                    ticks: {
                      display: false //this will remove only the label
                    }
                  }
                }
              }
            });

        }


        function show會員資料表(){
          $('#chartDiv').hide();
          $('#會員資料表').show();
          $('#ml-資料標題').text('會員資料');
        }
               
        
        function show_membership_page(){
          $(".page-wrapper").hide(); // hide all pages with page-wrapper class
          $(".sidebar-item").css("color","white")

          $("#membership-page").show(); 
          queryMermbers();
          if (!index_is_loaded) {
            queryMermbers();
            index_is_loaded = true;     
          }
        }        


        
        function queryMermbers(){
          
          //測試
          var names=['龔X萱','吳X伯','王X佑','洪X銘','許X伶','張X青','張X富','劉X禮','林X豪','連X翰',
                     '李X揚','梁X嘉','趙X如','莊X貴','王X哲','陳X剛','陳X孜','王X芸','謝X鴻','蔡X一',
                     '張X霖','羅X冰','蘇X鈞','胡X倩','盧X聖','林X聖','林X菁','柳X倫','林X佳','陳X婷',
                     '劉X穎','張X皓','林X佩','毛X婷','劉X軒','吳X雲','楊X帆','曾X云','杜X然','黃X平',
                     '劉X剛','朱X苓','林X人','陳X瑋','陳X弘','黃X映','張X南','李X秀','郭X良','詹X貞',
                     '鄭X斌','蕭X惠','賴X伯','鄭X德','林X音','林X偉','陳X珠','蘇X軒','邱X云','林X宏',
                     '陳X婷','王X傑','陳X羽','吳X軒','黃X銘','劉X火','連X桂','吳X來','曾X惠','丁X梅',
                     '張X源','何X倩','何X倫','余X倫','宋X純','曾X娟','陸X容','黃X蓮','王X育','賴X啟',
                     '陳X意','朱X琳','林X夫','袁X穎','阮X傑','李X宇','林X君','林X易','黃X榮','王X香',
                     '邱X文','曹X豪','許X昀','王X瑞','林X軒','林X伶','林X淳','楊X貞','陳X祥','王X玲'];          
          for (var i=0;i<20; i+=2) {
            memberResult[i]=['ID'+i.toString().padStart(8, '0'),names[i],'男',names[i].substr(0,2)+"X",'','',true,];
            memberResult[i+1]=['ID'+(i+1).toString().padStart(8,'0'),names[i+1],'女',names[i+1].substr(0,2)+"X",'','',true,''];
          }
          
          memberTable.clear();
          memberTable.rows.add(memberResult).draw();
          
          return 
          //
          
          var startDateStr = $("#rsvQueryStartDate").val();
          var endDateStr = $("#rsvQueryEndDate").val();

          console.log(startDateStr, endDateStr);

          var apiUrl = apiUrlBase + "?API=00" + "&StartDate=" + startDateStr +"&EndDate=" + endDateStr;

          //console.log(apiUrl);

          $.loading.start('讀取資料');
          $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(returnData) {
              //returnFromAPI = JSON.parse(JSON.stringify(returnData));
              //console.log(returnFromAPI[0][3]);

              memberResult = returnData;

              for (i=0; i< memberResult.length; i++){
                memberResult[i][4] = memberResult[i][3].substr(11,5)+'~'+memberResult[i][4].substr(11,5);
                memberResult[i][3] = memberResult[i][3].substr(0,10);
              }

              console.log(memberResult);
              
              memberTable.clear();
              memberTable.rows.add(memberResult).draw();
              $.loading.end();              
            },

            error: function() {
              alert("Database READ ERROR!!!");
            }
          });             
        }        
        
        
        
        
        
        
        
        
        
        
        
        //以下目前沒用，先保留
        

        var expirationsTable  =$('#expirations').DataTable( {
          dom: 'Bfrtip',
          buttons: [
            { "extend": 'csv', "text":'<span id="ml-匯出CSV">匯出 CSV</span>',"className": 'btn-gradient-primary font-weight-bold' },
            { "extend": 'excel', "text":'<span id="ml-匯出EXCEL">匯出 EXCEL</span>',"className": 'btn-gradient-primary font-weight-bold' }
          ],
          order: [[ 5, "asc" ]],
          data: expResult,
          columnDefs: [                  
          ]           
        } );

        var querySessionsTable  =$('#query-sessions').DataTable( {
          dom: 'Bfrtip',
          buttons: [
            { "extend": 'csv', "text":'<span id="ml-匯出CSV">匯出 CSV</span>',"className": 'btn-gradient-primary font-weight-bold' },
            { "extend": 'excel', "text":'<span id="ml-匯出EXCEL">匯出 EXCEL</span>',"className": 'btn-gradient-primary font-weight-bold' }
          ],
          order: [[ 2, "asc" ], [ 0, "asc" ], [ 1, "asc" ]],
          data: querySessionsResult,
          columnDefs: [ 
            {
              targets: [12,13,14,16,20,22,23,24,25,26,27,28,29],
              render: $.fn.dataTable.render.number(',', '.', 2),
              className: 'number-to-right'
            },
            {
              targets: [8,17,18,19,21],
              className: 'number-to-right'
            }            
          ]           
        } );
        
        function show_expire_page(){
          $(".page-wrapper").hide();
          $(".sidebar-item").css("color","white")

          $("#expire-page").show();   
          //$("#ml-Sidebar-check-reservations").css("color", "white");                      
          $("#ml-Sidebar-check-expirations").css("color", "#FBF279");
          //$("#sidebar-check-reservations-icon").css("color", "white");              
          //$("#sidebar-check-expirations-icon").css("color", "#FBF279");
          if (!expire_is_loaded) {
            checkExpirations();
            expire_is_loaded = true;     
          }
        } 

        function show_query_sessions_page(){
          $(".page-wrapper").hide();
          $(".sidebar-item").css("color","white")

          $("#query-sessions-page").show();   
          //$("#ml-Sidebar-check-reservations").css("color", "white");                      
          $("#ml-Sidebar-query-sessions").css("color", "#FBF279");
          if (!query_sessions_is_load) {
            querySessions();
            query_sessions_is_load = true;     
          }
        }            

        function checkReservations(){
          
          //測試
          var names=['龔X萱','吳X伯','王X佑','洪X銘','許X伶','張X青','張X富','劉X禮','林X豪','連X翰',
                     '李X揚','梁X嘉','趙X如','莊X貴','王X哲','陳X剛','陳X孜','王X芸','謝X鴻','蔡X一',
                     '張X霖','羅X冰','蘇X鈞','胡X倩','盧X聖','林X聖','林X菁','柳X倫','林X佳','陳X婷',
                     '劉X穎','張X皓','林X佩','毛X婷','劉X軒','吳X雲','楊X帆','曾X云','杜X然','黃X平',
                     '劉X剛','朱X苓','林X人','陳X瑋','陳X弘','黃X映','張X南','李X秀','郭X良','詹X貞',
                     '鄭X斌','蕭X惠','賴X伯','鄭X德','林X音','林X偉','陳X珠','蘇X軒','邱X云','林X宏',
                     '陳X婷','王X傑','陳X羽','吳X軒','黃X銘','劉X火','連X桂','吳X來','曾X惠','丁X梅',
                     '張X源','何X倩','何X倫','余X倫','宋X純','曾X娟','陸X容','黃X蓮','王X育','賴X啟',
                     '陳X意','朱X琳','林X夫','袁X穎','阮X傑','李X宇','林X君','林X易','黃X榮','王X香',
                     '邱X文','曹X豪','許X昀','王X瑞','林X軒','林X伶','林X淳','楊X貞','陳X祥','王X玲'];          
          for (var i=0;i<20; i+=2) {
            memberResult[i]=['ID'+i.toString().padStart(8, '0'),names[i],'男',names[i].substr(0,2)+"X",'','',true,];
            memberResult[i+1]=['ID'+(i+1).toString().padStart(8,'0'),names[i+1],'女',names[i+1].substr(0,2)+"X",'','',true,''];
          }
          memberTable.clear();
          memberTable.rows.add(memberResult).draw();
          
          return 
          //
          
//          var startDateStr = $("#rsvQueryStartDate").val();
//          var endDateStr = $("#rsvQueryEndDate").val();
//
//          console.log(startDateStr, endDateStr);
//
//          var apiUrl = apiUrlBase + "?API=00" + "&StartDate=" + startDateStr +"&EndDate=" + endDateStr;
//
//          //console.log(apiUrl);
//
//          $.loading.start('讀取資料');
//          $.ajax({
//            url: apiUrl,
//            type: "GET",
//            dataType: "json",
//            success: function(returnData) {
//              //returnFromAPI = JSON.parse(JSON.stringify(returnData));
//              //console.log(returnFromAPI[0][3]);
//
//              memberResult = returnData;
//
//              for (i=0; i< memberResult.length; i++){
//                memberResult[i][4] = memberResult[i][3].substr(11,5)+'~'+memberResult[i][4].substr(11,5);
//                memberResult[i][3] = memberResult[i][3].substr(0,10);
//              }
//
//
//              memberTable.clear();
//              memberTable.rows.add(memberResult).draw();
//              $.loading.end();
//              $("#ml-Sidebar-check-reservations").css("color", "#FBF279");                
//              $("#sidebar-check-reservations-icon").css("color", "#FBF279");                
//            },
//
//            error: function() {
//              alert("Database READ ERROR!!!");
//            }
//          });             
        }

        function checkExpirations(){
          var startDateStr = $("#expQueryStartDate").val();
          var endDateStr = $("#expQueryEndDate").val();

          console.log(startDateStr, endDateStr);

          var apiUrl = apiUrlBase + "?API=01" + "&StartDate=" + startDateStr +"&EndDate=" + endDateStr;

          //console.log(apiUrl);

          $.loading.start('讀取資料');
          $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(returnData) {
              expResult = returnData;

              for (i=0; i< expResult.length; i++){
                expResult[i][5] = expResult[i][5].substr(0,10);
                expResult[i][6] = expResult[i][6].substr(0,10);
                expResult[i][7] = expResult[i][7].substr(0,10);
              }

              expirationsTable.clear();
              expirationsTable.rows.add(expResult).draw();
              $.loading.end();
            },

            error: function() {
              alert("Database READ ERROR!!!");
            }
          });             
        }
        
        function querySessions(){
          
          // Get settings of all Courses
          
          
          
          var startDateStr = $("#sessionQueryStartDate").val();
          var endDateStr = $("#sessionQueryEndDate").val();

          console.log(startDateStr, endDateStr);

          var apiUrl = apiUrlBase + "?API=03" + "&StartDate=" + startDateStr +"&EndDate=" + endDateStr; // API=03 為只搜尋單一合約的 sessions

          //console.log(apiUrl);

          $.loading.start('讀取資料');
          $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(returnData) {
              //returnFromAPI = JSON.parse(JSON.stringify(returnData));
              //console.log(returnFromAPI[0][3]);
              
              //querySessionsResult = JSON.parse(JSON.stringify(returnData));
              var querySessionsResultRaw = JSON.parse(JSON.stringify(returnData));
              console.log(querySessionsResultRaw);
              querySessionsResult=[];
              for (var i=0; i< querySessionsResultRaw.length; i++){
                if (querySessionsResultRaw[i][30]==true) {
                  querySessionsResult.push(querySessionsResultRaw[i]);
                }
              }
              processContractSessionHistory();
            },

            error: function() {
              alert("Database READ ERROR!!!");
            }
          });             
        }
        
        async function getCourseSettings() {
          
          var apiUrl;       
          

          apiUrl = apiUrlBase + "?API=05"; 
          await $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(returnData) {
              for (var i=0; i< returnData.length; i++){
                courseSettings[returnData[i][0]] = returnData[i][1];
              }
            },

            error: function() {
              alert("Database READ ERROR!!!");
            }
          }); 
        }
                    
        async function processContractSessionHistory() {
          
          var apiUrl;
          
          $.loading.end();
          $.loading.start("讀取課程設定");
          apiUrl = apiUrlBase + "?API=05"; 
          await $.ajax({
            url: apiUrl,
            type: "GET",
            dataType: "json",
            success: function(returnData) {
              for (var i=0; i< returnData.length; i++){
                courseSettings[returnData[i][0]] = returnData[i][1];
              }
            },

            error: function() {
              alert("Database READ ERROR!!!");
            }
          });
          
          
          // collect contracts need to be queried
          var contractsToQuery=[];
          for (i=0; i< querySessionsResult.length; i++){
              contractsToQuery.push(querySessionsResult[i][5])
          }
          //console.log(contractsToQuery);          
          
          for (var j=0; j<contractsToQuery.length;j++) {
            if (contractSessionHistory[querySessionsResult[j][4]]== undefined) {
              apiUrl = apiUrlBase + "?API=04" + "&contractId=" + contractsToQuery[j]; 
              
              $.loading.end();$.loading.start("讀取合約:"+contractsToQuery[j]);
              await $.ajax({
                url: apiUrl,
                type: "GET",
                dataType: "json",
                success: function(returnData) {
                  contractSessionHistory[contractsToQuery[j]] = [];
                  for (var i=0; i < returnData.length; i++) {
                    contractSessionHistory[contractsToQuery[j]].push( returnData[i][0].substr(0,10) + " " + returnData[i][0].substr(11,5)+'~'+returnData[i][1].substr(11,5) );
                  }
                },

                error: function() {
                  alert("Database READ ERROR!!!");
                }
              }); 
              //console.log(contractsToQuery[j], "  done"); 
            }
          }
          
          var currentDate="0000-00-00";
          var sessionIndexForDay = 1;
          var amountForDay=0;
          var storeId = "TW-Xinyi";
          for (i=0; i< querySessionsResult.length; i++){

            // 處理日期和時間
            querySessionsResult[i][1] = querySessionsResult[i][0].substr(11,5)+'~'+querySessionsResult[i][1].substr(11,5);
            querySessionsResult[i][0] = querySessionsResult[i][0].substr(0,10);
            
                      
            
            // 合約時間_月 
            querySessionsResult[i][8] = courseSettings[querySessionsResult[i][7]];

            // 合約簽訂日期，Database ContractForms 裡的 ProcessTime
            querySessionsResult[i][9] = querySessionsResult[i][9].substr(0,10);
            
            // 合約開始日期，Database ContractForms 裡的 CourseSessionFirstStartDate           
            querySessionsResult[i][10] = querySessionsResult[i][10].substr(0,10);
            
            // 處理 合約到期日期
              // 合約到期日期，Database ContractForms 裡的 ExpirationDate 
              querySessionsResult[i][11] = querySessionsResult[i][11].substr(0,10);       

              // 合約延伸到期日期，Database ContractForms 裡的 ExpirationDate 
              querySessionsResult[i][31] = querySessionsResult[i][31].substr(0,10);   

              // 如果有延伸，結合兩個日期
              if (querySessionsResult[i][31] > "0001-01-01") {
                querySessionsResult[i][11] = querySessionsResult[i][11] + "<br>Ext. " + querySessionsResult[i][31];
              }
            
            
            // 處理 合約已進行(月)
            var startDate = new Date(querySessionsResult[i][9]);
            var endDate = new Date(querySessionsResult[i][0]);
            querySessionsResult[i][12] = Math.floor((endDate - startDate)/(864000*30))/100;

            // 處理 合約總價(未稅)
            //querySessionsResult[i][13] = Math.floor(parseFloat(querySessionsResult[i][13])*100)/100;  

            // 處理 合約總價(未稅)
            querySessionsResult[i][14] = parseFloat(querySessionsResult[i][13])/1.05;  

            // 處理 合約已執行堂數                
            var sessionDateTime = querySessionsResult[i][0]+ " " + querySessionsResult[i][1];
            //if (contractSessionHistory[querySessionsResult[i][4]].length >0){
            //  console.log(contractSessionHistory[querySessionsResult[i][4]].indexOf(sessionDateTime)+1);
            //}

            querySessionsResult[i][19] =contractSessionHistory[querySessionsResult[i][5]].indexOf(sessionDateTime)+1;

            // 處理 開始後來店頻率，因為會用到 querySessionsResult[i][18]，所以才放在之後，
            var usedMonth = (querySessionsResult[i][12] == 0)?1:querySessionsResult[i][12];
            querySessionsResult[i][16] = parseFloat(querySessionsResult[i][19])/usedMonth;
             

            // 處理 合約剩餘堂數                
            querySessionsResult[i][21] = querySessionsResult[i][18] - querySessionsResult[i][19];


            // 處理 課程單價(含稅)               
            querySessionsResult[i][22] = parseFloat(querySessionsResult[i][13])/parseFloat(querySessionsResult[i][18]);                 

            // 處理 課程單價(未稅)              
            querySessionsResult[i][23] = parseFloat(querySessionsResult[i][14])/parseFloat(querySessionsResult[i][18]);                

            // 合約退會堂數, 退費金額/課程單價(含稅)
            querySessionsResult[i][20] = querySessionsResult[i][20]/querySessionsResult[i][22];               
            
            
            // 處理 合約已認列金額(含稅)
            querySessionsResult[i][24] = (querySessionsResult[i][19] * parseFloat(querySessionsResult[i][13])) / 
                                         parseFloat(querySessionsResult[i][18]);

            // 處理 合約已認列金額(未稅)
            querySessionsResult[i][25] = querySessionsResult[i][24] / 1.05;

            // 處理 合約未認列金額(含稅)
            querySessionsResult[i][26] = querySessionsResult[i][13] - querySessionsResult[i][24];

            // 處理 合約未認列金額(未稅)
            querySessionsResult[i][27] = querySessionsResult[i][14] - querySessionsResult[i][25];                
            if ( querySessionsResult[i][2] != storeId) {
              console.log("store change");
              storeId = querySessionsResult[i][2];
              currentDate = "0000-00-00";
            }
            
            if (querySessionsResult[i][0] > currentDate) {
              //console.log("new day");
              currentDate = querySessionsResult[i][0];
              sessionIndexForDay = 1;
              querySessionsResult[i][17] = sessionIndexForDay++; 
              // 當日認列金額(含稅)
              querySessionsResult[i][28] = querySessionsResult[i][22];

            
            } else {
              // 堂數排序 not implement yet
              querySessionsResult[i][17] = sessionIndexForDay++; 
              querySessionsResult[i][28] = querySessionsResult[i][22]+querySessionsResult[i-1][28];
            }
            
            // 當日認列金額(未稅)
            querySessionsResult[i][29] = querySessionsResult[i][28]/1.05;  
                           
          }

          querySessionsTable.clear();
          querySessionsTable.rows.add(querySessionsResult).draw();
          $.loading.end();          
          
        }
        //以上目前沒用，先保留
      </script>
      
      <script>
        $("#checkDetails0").css("background-color", "rgb(255,67,80)");
        $("#checkDetails0").css("color", "rgb(255,255,255)");
      </script>
       
      <style>
        ::-webkit-calendar-picker-indicator {
          filter: invert(0.5);
        }
      </style>
        
    </body>
</html>
